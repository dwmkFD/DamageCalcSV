@inherits LayoutComponentBase
@inject ILogger<MainLayout> Logger_

<MudThemeProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<div class="page">
<!--
    <div class="sidebar">
        <NavMenu />
    </div>
-->
    <main>
        <!--
            <div class="top-row px-4">
                <a href="https://docs.microsoft.com/aspnet/" target="_blank">About</a>
            </div>

            <article class="content px-4">
            </article>
    -->
        <div class="top-row px-4">
            <p>Pokemon SV Damage Calculator</p>
        </div>
        <MudLayout>
            <MudMainContent>
                <MudGrid Spacing="@spacing" Justify="Justify.Center">
                    <MudItem xs="4" />
                    <MudItem xs="4">
                        <MudPaper Class="d-flex align-center justify-center mud-width-full py-1">
                    <MudForm>
                                <MudRadioGroup @bind-SelectedOption="@DamageCalcSV.Shared.Models.DamageCalc.SelectedBattleStyle">
                                <MudRadio Option="0">シングル</MudRadio>
                                <MudRadio Option="1">ダブル</MudRadio>
                            </MudRadioGroup>
                        </MudForm>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="4" />

                    <MudItem xs="6">
                            <MudForm>
                            <MudRadioGroup @bind-SelectedOption="@DamageCalcSV.Shared.Models.DamageCalc.SelectedWeatherSettings">
                                    <MudGrid Spacing="@spacing" Justify="Justify.Center">
                                    <MudItem xs="1" />
                                    <MudItem xs="2">
                                        <MudRadio Option="0" Size="Size.Small">‐</MudRadio>
                                    </MudItem>
                                    <MudItem xs="2">
                                    <MudRadio Option="1" Size="Size.Small">晴れ</MudRadio>
                                    </MudItem>
                                    <MudItem xs="2">
                                    <MudRadio Option="2" Size="Size.Small">雨</MudRadio>
                                    </MudItem>
                                    <MudItem xs="2">
                                    <MudRadio Option="3" Size="Size.Small">砂嵐</MudRadio>
                                    </MudItem>
                                    <MudItem xs="2">
                                    <MudRadio Option="4" Size="Size.Small">雪</MudRadio>
                                    </MudItem>
                                    <MudItem xs="1" />
                                    </MudGrid>
                                </MudRadioGroup>
                            </MudForm>
                    </MudItem>
                    <MudItem xs="6">
                            <MudForm>
                            <MudRadioGroup @bind-SelectedOption="@DamageCalcSV.Shared.Models.DamageCalc.SelectedFieldSettings">
                                    <MudGrid Spacing="@spacing" Justify="Justify.Center">
                                    <MudItem xs="1" />
                                    <MudItem xs="2">
                                    <MudRadio Option="0" Size="Size.Small">‐</MudRadio>
                                    </MudItem>
                                    <MudItem xs="2">
                                        <MudRadio Option="1" Size="Size.Small">エレキ</MudRadio>
                                    </MudItem>
                                    <MudItem xs="2">
                                        <MudRadio Option="2" Size="Size.Small">グラス</MudRadio>
                                    </MudItem>
                                    <MudItem xs="2">
                                        <MudRadio Option="3" Size="Size.Small">サイコ</MudRadio>
                                    </MudItem>
                                    <MudItem xs="2">
                                        <MudRadio Option="4" Size="Size.Small">ミスト</MudRadio>
                                    </MudItem>
                                    <MudItem xs="1" />
                                </MudGrid>
                            </MudRadioGroup>
                            </MudForm>
                    </MudItem>

                    <MudItem xs="2">
                            <MudForm>
                            <MudCheckBox @bind-Checked="@DamageCalcSV.Shared.Models.DamageCalc.Gravity" Size="Size.Small" Label="じゅうりょく" Margin="Margin.Dense"></MudCheckBox>
                            </MudForm>
                    </MudItem>
                    <MudItem xs="2">
                            <MudForm>
                            <MudCheckBox @bind-Checked="@DamageCalcSV.Shared.Models.DamageCalc.WonderRoom" Size="Size.Small" Label="ワンダールーム" Margin="Margin.Dense"></MudCheckBox>
                            </MudForm>
                    </MudItem>
                    <MudItem xs="2">
                            <MudForm>
                            <MudCheckBox @bind-Checked="@DamageCalcSV.Shared.Models.DamageCalc.PlasmaShower" Size="Size.Small" Label="プラズマシャワー" Margin="Margin.Dense"></MudCheckBox>
                            </MudForm>
                    </MudItem>
                    <MudItem xs="2">
                            <MudForm>
                            <MudCheckBox @bind-Checked="@DamageCalcSV.Shared.Models.DamageCalc.FairyAura" Size="Size.Small" Label="フェアリーオーラ" Margin="Margin.Dense"></MudCheckBox>
                            </MudForm>
                    </MudItem>
                    <MudItem xs="2">
                            <MudForm>
                            <MudCheckBox @bind-Checked="@DamageCalcSV.Shared.Models.DamageCalc.DarkAura" Size="Size.Small" Label="ダークオーラ" Margin="Margin.Dense"></MudCheckBox>
                            </MudForm>
                    </MudItem>
                    <MudItem xs="2">
                            <MudForm>
                            <MudCheckBox @bind-Checked="@DamageCalcSV.Shared.Models.DamageCalc.AuraBreak" Size="Size.Small" Label="オーラブレイク" Margin="Margin.Dense"></MudCheckBox>
                            </MudForm>
                    </MudItem>

                    <MudItem xs="4">
                        <PokemonStatus Title="ポケモン1" OnStatusChangeEventCallback="@((x) => CalcDamage( x, 1 ))"></PokemonStatus>
                    </MudItem>
                    <MudItem xs="4">
                        <DamageResult Title="ダメージ計算一覧1" atk="pokemon1" def="pokemon2" damage_list="result1" damage_range="result2" damage_exp="result3" damage_min_max="result4"></DamageResult>
                    </MudItem>
                    <MudItem xs="4">
                        <PokemonStatus Title="ポケモン2" OnStatusChangeEventCallback="@((x) => CalcDamage( x, 2 ))"></PokemonStatus>
                    </MudItem>

                    <MudItem xs="4" />
                    <MudItem xs="4">
                        <DamageResult Title="ダメージ計算一覧2" atk="pokemon2" def="pokemon1" damage_list="result5" damage_range="result6" damage_exp="result7" damage_min_max="result8"></DamageResult>
                    </MudItem>
                    <MudItem xs="4" />
                </MudGrid>
                @Body
            </MudMainContent>
        </MudLayout>
    </main>
</div>

@code {
    [CascadingParameter] private UnexpectedException UnexpectedException_ { get; set; }
    public int spacing { get; set; } = 2;

    private DamageCalcSV.Shared.Models.PokemonDataReal? pokemon1 = null, pokemon2 = null;
    private List<KeyValuePair<string, List<int>>>? result1 = null;
    private Dictionary<string, string>? result2 = null;
    private Dictionary<string, string>? result3 = null;
    private Dictionary<string, Tuple<int, int>>? result4 = null;
    private List<KeyValuePair<string, List<int>>>? result5 = null;
    private Dictionary<string, string>? result6 = null;
    private Dictionary<string, string>? result7 = null;
    private Dictionary<string, Tuple<int, int>>? result8 = null;
    private DamageCalcSV.Shared.Models.DamageCalc Damage = new DamageCalcSV.Shared.Models.DamageCalc();

    private Tuple<List<KeyValuePair<string, List<int>>>, Dictionary<string, string>, Dictionary<string, string>, Dictionary<string, Tuple<int, int>>> CalcDamageMain(DamageCalcSV.Shared.Models.PokemonDataReal atk, DamageCalcSV.Shared.Models.PokemonDataReal def)
    {
        var tmp_result = Damage.calc(atk, def);
        List<KeyValuePair<string, int>> tmp = new List<KeyValuePair<string, int>>();
        List<KeyValuePair<string, List<int>>> res1 = new List<KeyValuePair<string, List<int>>>();
        Dictionary<string, string> res2 = new Dictionary<string, string>();
        Dictionary<string, string> res3 = new Dictionary<string, string>();
        Dictionary<string, Tuple<int, int>> res4 = new Dictionary<string, Tuple<int, int>>();

        // 与えるダメージの期待値でソートする
        foreach( var t in tmp_result )
        {
            tmp.Add(KeyValuePair.Create(t.Key, t.Value.Last()));
        }
        tmp.Sort( ( a, b ) => b.Value - a.Value );
        foreach( var t in tmp )
        {
            res1.Add(KeyValuePair.Create(t.Key, tmp_result[t.Key]));
        }

        foreach( var r in res1 )
        {
            int min = Math.Max(def.HP - r.Value[0], 0);
            int max = Math.Max(def.HP - r.Value[15], 0);
            res2[r.Key] = (((double)r.Value[0] / def.HP) * 100.0).ToString("F1") + "% ～ " + (((double)r.Value[15] / def.HP) * 100.0).ToString("F1") + "%";
            res3[r.Key] = (((double)r.Value.Last() / def.HP ) * 100.0).ToString( "F1") + "%";
            res4[r.Key] = (Tuple.Create( max, min ));
        }

        return ( Tuple.Create( res1, res2, res3, res4 ) );
    }

    private void CalcDamage(DamageCalcSV.Shared.Models.PokemonDataReal p, int idx )
    {
        if (idx == 1) pokemon1 = p;
        else if ( idx == 2 ) pokemon2 = p;

        if (pokemon1 == null) return;
        if (pokemon2 == null) return;

        ( result1, result2, result3, result4 ) = CalcDamageMain(pokemon1, pokemon2);
        ( result5, result6, result7, result8 ) = CalcDamageMain(pokemon2, pokemon1);
    }
}